<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My HTML Page</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/fontawesome/css/font-awesome.min.css">
</head>
<body>
  <main>
    
    <div class="container">
      <div id="data">
        <!-- <label for="title">Tile:</label>
        <input type="text" id="title" name="title">
        <br>
        <label for="genre">Genre:</label>
        <input type="genre" id="genre" name="genre">
        <br>
        <label for="swaram">Swaram:</label>
        <textarea id="swaram" name="Swaram" rows="4" cols="50"></textarea>
        <br>
        <button type="submit" onclick="UpdateSong()">Submit</button> -->
      </div>
    </div>
  </main>
  <!-- <form id="myForm">
    <label for="title">Tile:</label>
    <input type="text" id="title" name="title">
    <br>
    <label for="genre">Genre:</label>
    <input type="genre" id="genre" name="genre">
    <br>
    <label for="swaram">Swaram:</label>
    <textarea id="swaram" name="Swaram" rows="4" cols="50"></textarea>
    <br>
    <button type="submit" onclick="UpdateSong()">Submit</button>
  </form> -->

  <script>
    const UpdateSong = () => {
      const title = document.getElementById("title").value;
      const genre = document.getElementById("genre").value;
      const swaram = document.getElementById("swaram").value;
      const swaras = swaram.split("\n");

      swaras.forEach(element => {
        const characters = element.split("");
        console.log(characters)
      });

      
      const data = {
        title: title,
        genre: genre
      };

      const jsonString = JSON.stringify(data);

      const blob = new Blob([jsonString], {type: "application/json"});
      const url = URL.createObjectURL(blob);

      const downloadLink = document.createElement("a");
      downloadLink.href = url;
      downloadLink.download = "data.json";
      // downloadLink.click();
    };

    window.addEventListener("DOMContentLoaded", () => {
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const songId = urlParams.get("id");
      const genreParam = urlParams.get("genre");

      if (songId) {
        getSwaram(songId)
      }

    });

     function getSwaram(id) {
        const fmtId = id.replace(/-/g, "/")
        const fileName = `data/${fmtId}.json`
        loadData(fileName, processData)
      }

      const loadData = (fileName, callback) => {
        const xObj = new XMLHttpRequest();
        xObj.overrideMimeType("application/json");
        xObj.open('GET', fileName, true);
        xObj.onreadystatechange = () => {
          if (xObj.readyState === 4 && xObj.status === 200) {
            // console.log(xObj.responseText)
            callback(xObj.responseText);
          }
          // else{
          //   alert('File Not Found')
          // }
        };
        xObj.send(null);
      }

      const processData = (response) => {
        localStorage.setItem("song", response);
        const jsonData = JSON.parse(response);
        renderElem(jsonData)
      };

      /**
       * Render Element
       * @param {Object} data
       */

      const renderElem = (data) => {
        // console.log(data)
          const dataElem = document.querySelector("#data");
          // Remove all children from Swaram Table, if any
          while (dataElem.firstChild) dataElem.removeChild(dataElem.firstChild)

          let songFull = document.createElement("div")
          songFull.className = "song-full"

          let titleHolder = document.createElement("div")
          titleHolder.className = "song-partial"

          let songTitle = document.createElement("input", 
              {type: "text", id: "titleMain", name: "titleMain"});
          songTitle.className = "song-title"
          songTitle.value = data.title
          songTitle.style = "background-color: transparent; border: none;"
          titleHolder.append(songTitle);
          songFull.append(titleHolder);



          data.songs.forEach(song => {
            let songPartial = document.createElement("div")
            songPartial.className = "song-partial"

            let songAttrs = document.createElement("div")
            songAttrs.className = "song-info"

            let titleLbl = document.createElement("label", { for: "songTitle"})
            titleLbl.innerHTML = `<strong>Title:</strong>`
            let titleTxt = document.createElement("input", {type: "text", name: "songTitle"})
            titleTxt.value = song.title
            titleTxt.style = "background-color: transparent; border: none; width: auto;"
            songAttrs.append(titleLbl, titleTxt)

            let raagamLbl = document.createElement("label", { for: "raagamTitle" })
            raagamLbl.innerHTML = `<strong>Raagam:</strong>`
            let raagamTxt = document.createElement("input", { type: "text", name: "raagamTitle" })
            raagamTxt.value = song.raagam
            raagamTxt.style = "background-color: transparent; border: none; width: auto;"
            songAttrs.append(raagamLbl, raagamTxt)


            let thaalamLbl = document.createElement("label", { for: "thaalamTitle" })
            thaalamLbl.innerHTML = `<strong>Thaalam:</strong>`
            let thaalamTxt = document.createElement("input", { type: "text", name: "thaalamTitle" })
            thaalamTxt.value = song.thaalam
            thaalamTxt.style = "background-color: transparent; border: none; width: auto;"
            songAttrs.append(thaalamLbl, thaalamTxt)


            let dynamics = document.createElement("div")
            dynamics.className = "song-dyn"

            let arohanamLbl = document.createElement("label", { for: "arohanamTitle" })
            arohanamLbl.innerHTML = `<strong>Arohanam:</strong>`
            let arohanamTxt = document.createElement("input", { type: "text", name: "arohanamTitle" })
            arohanamTxt.value = song.arohanam
            arohanamTxt.style = "background-color: transparent; border: none; width: auto;"
            dynamics.append(arohanamLbl, arohanamTxt)



            let avarohanamLbl = document.createElement("label", { for: "avarohanamTitle" })
            avarohanamLbl.innerHTML = `<strong>Avarohanam:</strong>`
            let avarohanamTxt = document.createElement("input", { type: "text", name: "avarohanamTitle" })
            avarohanamTxt.value = song.avarohanam
            avarohanamTxt.style = "background-color: transparent; border: none; width: auto;"
            dynamics.append(avarohanamLbl, avarohanamTxt)


            songAttrs.append(dynamics)

            // Append Song Information
            songPartial.append(songAttrs)

            

            const index = data.songs.indexOf(song)
            let songBody = addSongPara(song, index)
            songPartial.append(songBody)
            songFull.append(songPartial)


            dataElem.append(songFull)
          })
        }

        /**
         * Add Song Paragraph
         * @param {Object} song
         * @param {Number} songIndex
         */
        const addSongPara = (song, songIndex) => {
          
          let songBody = document.createElement("div")
          songBody.className = "song-body"
          song.swaram.forEach(swar => {
            let swarIndex = song.swaram.indexOf(swar);
            let songPara = document.createElement("div")
            songPara.className = "song-para"


            // Add Icon
            const addIconElem = document.createElement("i");
            addIconElem.className = "fa fa-plus";
            addIconElem.style = "margin-left: 5px";
            addIconElem.addEventListener("click", () => {
              addNewBlock(songIndex, swarIndex)
            });

            // Del Icon
            const remIconElem = document.createElement("i");
            remIconElem.className = "fa fa-minus";
            remIconElem.style = "margin-left: 5px";
            remIconElem.addEventListener("click", () => {
              removeBlock(songIndex, swarIndex)
            });

            // icons.append(addIconElem);
            songPara.append(addIconElem, remIconElem)



            let swrValues = new Array()
            if (swar.syllable.sign && swar.syllable.sign.length > 0) {
              const signs = swar.syllable.sign.map(item => item)

              //Append repeat number to the last array item
              if (swar.repeat > 0)
                signs.splice(signs.length - 1, 1, `${signs[signs.length - 1]} (${swar.repeat})`)

              signs.push("swrValues")  // CSS Class Name for Swaram Row
              swrValues.push(signs)
              songPara.append(renderTextBlock(songIndex, swarIndex, swrValues))
            }

            let lyrValues = new Array()
            if (swar.syllable.lyric && swar.syllable.lyric.length > 0) {
              const lyrics = swar.syllable.lyric.map(item => item)
              // lyrics.unshift("") // Just for Indent
              lyrics.push("lyrValues")

              lyrValues.push(lyrics)
              songPara.append(renderTextBlock(songIndex, swarIndex, lyrValues))
            }
            songBody.append(songPara)
            
          })
          return songBody
        }
        
      /**
       * Add Song Swar Element Block
       * @param {Object} song
       * @param {Number} songIndex
       */
      const renderTextBlock = (songIndex, swarIndex, data) => {
        let elemBlock = document.createElement('div')
        data.forEach(value => {
          elemBlock.className = value[value.length - 1]
          elemBlock.append(addBlock(songIndex, swarIndex, value))
        })
        return elemBlock
      }
      

      /**
       * Add Lyric Block to Swaram
       * @param {Boolean} icon
       * @param {Array} tblValues
       * @returns {HTMLElement}
       **/
      // const addLyrBlock = (icon, tblValues) => {
      //   let tblBodyRow = document.createElement('div')
      //   tblValues.forEach(body => {
      //     tblBodyRow.className = body[body.length - 1]
      //     addBlock(tblBodyRow, body)
      //   })
      //   return tblBodyRow
      // }

      /**
       * Add Swar Block to Swaram
       * @param {Boolean} icon
       * @param {Array} tblValues
       * @returns {HTMLElement}
       **/
      // const addSwarBlock = (icon, tblValues) => {
      //   let tblBodyRow = document.createElement('div')
      //   tblValues.forEach(body => {
      //     tblBodyRow.className = body[body.length - 1]
      //     addBlock(tblBodyRow, body)
      //   })
      //   return tblBodyRow
      // }

      /**
       * Add Element Block to Swaram & Lyric
       * @param {HTMLElement} elem
       * @param {Array} obj
       * @returns {void}
       **/
      const addBlock = (songIndex, swarIndex, value) => {
        for (let i = 0; i < value.length - 1; i++) {
          let swrBlock = document.createElement("input", { type: "text", name: "swrBlock" })
          swrBlock.addEventListener("focusout", () => {
            saveData()
          });
          swrBlock.value = value[i]
          swrBlock.style = "background-color: transparent; border: none"
          return swrBlock
        }
      }

      /**
       * Add New Swaram Block
       * @param {Number} songIndex
       * @param {Number} swarIndex
       */
      const addNewBlock = (songIndex, swarIndex) => {
        let data = localStorage.getItem("song");
        if (data) {
          const parsedData = JSON.parse(data);
          const emptySwar = '{"syllable": {"sign": ["",""],"lyric": ["",""]},"repeat": 0}'
          parsedData.songs[songIndex].swaram.splice(swarIndex + 1, 0, JSON.parse(emptySwar))
          const updatedData = JSON.stringify(parsedData)
          processData(updatedData)

        }
      }

      /**
       * Remove existing Swaram Block
       * @param {Number} songIndex
       * @param {Number} swarIndex
       */
      const removeBlock = (songIndex, swarIndex) => {
        let data = localStorage.getItem("song");
        if (data) {
          const parsedData = JSON.parse(data);
          parsedData.songs[songIndex].swaram.splice(swarIndex , 1)
          const updatedData = JSON.stringify(parsedData)
          processData(updatedData)

        }
      }

  </script>
</body>
</html>
