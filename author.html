<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My HTML Page</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/fontawesome/css/font-awesome.min.css">
</head>
<body>
  <main>
    
    
    <div class="container">
      <button id="btn-home" class="btn-style">
        Home
      </button>
      <button id="btn-save" class="btn-style">
        Save
      </button>
      <div id="data">
        <!-- <label for="title">Tile:</label>
        <input type="text" id="title" name="title">
        <br>
        <label for="genre">Genre:</label>
        <input type="genre" id="genre" name="genre">
        <br>
        <label for="swaram">Swaram:</label>
        <textarea id="swaram" name="Swaram" rows="4" cols="50"></textarea>
        <br>
        <button type="submit" onclick="UpdateSong()">Submit</button> -->
      </div>
    </div>
  </main>
  <!-- <form id="myForm">
    <label for="title">Tile:</label>
    <input type="text" id="title" name="title">
    <br>
    <label for="genre">Genre:</label>
    <input type="genre" id="genre" name="genre">
    <br>
    <label for="swaram">Swaram:</label>
    <textarea id="swaram" name="Swaram" rows="4" cols="50"></textarea>
    <br>
    <button type="submit" onclick="UpdateSong()">Submit</button>
  </form> -->

  <script>

    window.addEventListener("DOMContentLoaded", () => {
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const songId = urlParams.get("id");
      const genreParam = urlParams.get("genre");

      //Set OnClick attribute to Home button
      const btnHome = document.querySelector("#btn-home")
      btnHome.setAttribute("onclick", `window.location.href="search.html"`)

      // Set OnClick attribute to Save button
      const btnSave = document.querySelector("#btn-save")
      
      btnSave.setAttribute("onclick", `persistSongChanges()`)

      if (songId) {
        getSwaram(songId)
      }

    });

     function getSwaram(id) {
        const fmtId = id.replace(/-/g, "/")
        const fileName = `data/${fmtId}.json`
        loadData(fileName, processData)
      }

      const loadData = (fileName, callback) => {
        const xObj = new XMLHttpRequest();
        xObj.overrideMimeType("application/json");
        xObj.open('GET', fileName, true);
        xObj.onreadystatechange = () => {
          if (xObj.readyState === 4 && xObj.status === 200) {
            // console.log(xObj.responseText)
            callback(xObj.responseText);
          }
          // else{
          //   alert('File Not Found')
          // }
        };
        xObj.send(null);
      }

      const processData = (response) => {
        localStorage.setItem("song", response);
        const jsonData = JSON.parse(response);
        renderElem(jsonData)
      };

      /**
       * Render Element
       * @param {Object} data
       */

      const renderElem = (data) => {
        // console.log(data)
          const dataElem = document.querySelector("#data");
          // Remove all children from Swaram Table, if any
          while (dataElem.firstChild) dataElem.removeChild(dataElem.firstChild)

          let songFull = document.createElement("div")
          songFull.className = "song-full"

          // add title block
          songFull.append(addSongTitle(data))

          data.songs.forEach((song, index) => {
            let songStanza = document.createElement("div")
            songStanza.className = "song-stanza"
            // add Song Metadata
            songStanza.append(addSongMetadata(song))
            // const index = data.songs.indexOf(song)
            let songBody = addSongBody(song, index)
            songStanza.append(songBody)
            songFull.append(songStanza)
            dataElem.append(songFull)
          })
        }

        
        const addSongTitle = (song) => {
          let elemBlock = document.createElement("div")
          elemBlock.className = "song-title-block"

          const titleElem = renderSongMetadata({ id: "title", title: "Title: ", value: song.title, className: "song-title" })
          elemBlock.append(titleElem)

          const genreElem = renderSongMetadata({ id: "genre", title: "Genre: ", value: song.genre, className: "song-title" })
          elemBlock.append(genreElem)

          const composerElem = renderSongMetadata({ id: "composer", title: "Composer: ", value: song.composer, className: "song-title" })
          elemBlock.append(composerElem)
          return elemBlock
        }

        const addSongMetadata = (song) => {
          let elemBlock = document.createElement("div")
          elemBlock.className = "song-metadata-block"

          // Song Raagam
          const raagamElem = renderSongMetadata({ id: "raagam", title: "Raagam: ", value: song.raagam, className: "song-metadata" })
          elemBlock.append(raagamElem)

          // Song Thaalam
          const thaalamElem = renderSongMetadata({ id: "thalam", title: "Thalam: : ", value: song.thaalam, className: "song-metadata" })
          elemBlock.append(thaalamElem)

          // Song Arohanam
          const arohanamElem = renderSongMetadata({ id: "arrohanam", title: "Arohanam: ", value: song.avarohanam, className: "song-metadata" })
          elemBlock.append(arohanamElem)

          // Song Avarohanam
          const avarohanamElem = renderSongMetadata({ id: "avarohanam", title: "Avarohanam: ", value: song.avarohanam, className: "song-metadata" })
          elemBlock.append(avarohanamElem)
          
          
          return elemBlock
        }

        const renderSongMetadata = (obj) => {
          let metaBlock = document.createElement("div")
          metaBlock.className = obj.className
          let metaLbl = document.createElement("label")
          metaLbl.for = obj.name
          metaLbl.innerHTML = obj.title
          let metaVal = document.createElement("input")
          metaVal.type = "text"
          metaVal.id = obj.id
          metaVal.value = obj.value
          metaBlock.append(metaLbl, metaVal)
          return metaBlock
        }


        /**
         * Add Song Paragraph
         * @param {Object} song
         * @param {Number} songIndex
         */
        const addSongBody = (song, songIndex) => {
          let songBody = document.createElement("div")
          songBody.className = "song-body"
          song.swaram.forEach((swar, swarIndex) => {

            // let swarIndex = song.swaram.indexOf(swar);
            let songPara = document.createElement("div")
            songPara.className = "song-para"

            // Add Icon
            const addIconElem = document.createElement("i");
            addIconElem.className = "fa fa-plus";
            addIconElem.style = "margin-left: 5px";
            addIconElem.addEventListener("click", () => {
              addNewBlock(songIndex, swarIndex)
            });

            // Del Icon
            const remIconElem = document.createElement("i");
            remIconElem.className = "fa fa-minus";
            remIconElem.style = "margin-left: 5px";
            remIconElem.addEventListener("click", () => {
              removeBlock(songIndex, swarIndex)
            });

            // Repeat Number
            const repeatElem = renderValBlock("repeat", songIndex, swarIndex, null, swar.repeat, "swrRepeat-input")
            // const repeatElem = document.createElement("input")
            // repeatElem.type = "text"
            // repeatElem.setAttribute("maxlength", "2");
            // repeatElem.name = "repeat"
            // repeatElem.className = "swrRepeat-input"
            // repeatElem.value = swar.repeat

            // icons.append(addIconElem);
            songPara.append(addIconElem, remIconElem, repeatElem)



            // let swrValues = new Array()
            if (swar.syllable.sign && swar.syllable.sign.length > 0) {
              const signs = swar.syllable.sign.map(item => item)
              //Append repeat number to the last array item
              // if (swar.repeat > 0)
              //   signs.splice(signs.length - 1, 1, `${signs[signs.length - 1]} (${swar.repeat})`)
              // swrValues.push(signs)
              const attrs = {type: "sign", className: "swrValues" }
              songPara.append(renderSwarBlock(songIndex, swarIndex, signs, attrs))
            }

            // let lyrValues = new Array()
            if (swar.syllable.lyric && swar.syllable.lyric.length > 0) {
              const lyrics = swar.syllable.lyric.map(item => item)

              // lyrValues.push(lyrics)
              const attrs = { type: "lyric", className: "lyrValues" }
              songPara.append(renderSwarBlock(songIndex, swarIndex, lyrics, attrs))
            }
            songBody.append(songPara)
            
          })
          return songBody
        }
        
      /**
       * Add Song Swar Element Block
       * @param {Object} song
       * @param {Number} songIndex
       */
      const renderSwarBlock = (songIndex, swarIndex, valArr, attrs) => {
        let elemBlock = document.createElement('div')
        elemBlock.className = attrs.className
        valArr.forEach((val, valIndex) => {
          // elemBlock.append(...swarLine.reduce((acc, val) => {
          //   return acc.concat(renderValBlock(attrs.type, songIndex, swarIndex, val))
          // }, []))
          elemBlock.append(renderValBlock(attrs.type, songIndex, swarIndex, valIndex, val))
        })

        // if (repeat > 0) {
        //   elemBlock.append(renderValBlock(attrs.type, songIndex, swarIndex, repeat))
        // }
        return elemBlock
      }

      /**
       * Add Element Block to Swaram & Lyric
       * @param {HTMLElement} elem
       * @param {Array} obj
       * @returns {void}
       **/
      const renderValBlock = (swarType, songIndex, swarIndex, valIndex, swarVal, className) => {
          let elemBlock = document.createElement("input")
          elemBlock.type = "text"
          elemBlock.name = swarType
          elemBlock.value = swarVal
          if(className) elemBlock.className = className
          elemBlock.addEventListener("focusout", (event) => {
            const swarVal = event.target.value
            const swarType = event.target.name
            syncUpdate(songIndex, swarIndex, valIndex, swarType, swarVal)
          });
          return elemBlock
      }

      /**
       * Add New Swaram Block
       * @param {Number} songIndex
       * @param {Number} swarIndex
       */
      const addNewBlock = (songIndex, swarIndex) => {
        let data = localStorage.getItem("song");
        if (data) {
          const parsedData = JSON.parse(data);
          const emptySwar = '{"syllable": {"sign": ["",""],"lyric": ["",""]},"repeat": 0}'
          parsedData.songs[songIndex].swaram.splice(swarIndex + 1, 0, JSON.parse(emptySwar))
          const updatedData = JSON.stringify(parsedData)
          processData(updatedData)
        }
      }

      /**
       * Remove existing Swaram Block
       * @param {Number} songIndex
       * @param {Number} swarIndex
       */
      const removeBlock = (songIndex, swarIndex) => {
        let data = localStorage.getItem("song");
        if (data) {
          const parsedData = JSON.parse(data);
          parsedData.songs[songIndex].swaram.splice(swarIndex , 1)
          const updatedData = JSON.stringify(parsedData)
          processData(updatedData)

        }
      }

      const syncUpdate = (songIndex, swarIndex, valIndex, type, value) => {
        let data = localStorage.getItem("song");
        
        if (data) {
          data.id = `${data.genre}-${data.album}-${data.title}`.trim().replace(/\s+/g, '-').toLowerCase()
          const parsedData = JSON.parse(data);
          if(type === "sign")
            parsedData.songs[songIndex].swaram[swarIndex].syllable.sign[valIndex] = value
          else if(type === "lyric")
            parsedData.songs[songIndex].swaram[swarIndex].syllable.lyric[valIndex] = value
          else if(type === "repeat")
            parsedData.songs[songIndex].swaram[swarIndex].repeat = value
          const updatedData = JSON.stringify(parsedData)
          console.log(updatedData)
          processData(updatedData)
        }
      }

      const persistSongChanges = () => {
        let data = localStorage.getItem("song");
        if(data){
            const jsonData = JSON.stringify(data);
            const blob = new Blob([jsonData], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = data.id;
            a.click();
        }
      }


  </script>
</body>
</html>
