<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/fontawesome/css/font-awesome.min.css">
</head>

<body>
<div class="body">
  <div class="header">
    <a href="index.html" class="btn-style">Home</a>
    <a href="#" onclick="window.print()" class="btn-style">Print</a>
  </div>
  
  <div id="container" class="container">
  
  </div>
</div>
 

  <script>

    window.addEventListener("DOMContentLoaded", () => {
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const songId = urlParams.get("id");
      

      if (songId) {
        const fmtId = songId.replace(/-/g, "/")
        const fileName = `data/${fmtId}.json`
        loadData(fileName, processData)
      }
      else {
        loadData("data/schema.json", processData)
      }

    });

    const loadData = (fileName, callback) => {
      const xObj = new XMLHttpRequest();
      xObj.overrideMimeType("application/json");
      xObj.open('GET', fileName, true);
      xObj.onreadystatechange = () => {
        if (xObj.readyState === 4 && xObj.status === 200) {
          callback(xObj.responseText);
        }
        else{
          console.log('File Not Found')
        }
      };
      xObj.send(null);
    }

    const processData = (response) => {
      localStorage.setItem("song", response);
      const jsonData = JSON.parse(response);
      renderElem(jsonData)
    };

    /**
     * Render Element
     * @param {Object} data
     */

    const renderElem = (data) => {
      // Set window title to song title
      document.title = data.title;
      // console.log(data)
      const dataElem = document.querySelector("#container");
      // Remove all children from Swaram Table, if any
      while (dataElem.firstChild) dataElem.removeChild(dataElem.firstChild)

      let songFull = document.createElement("div")
      songFull.className = "song-full"

      // add title block
      songFull.append(addSongTitle(data))

      data.song.forEach((song, index) => {
        let songInstance = document.createElement("div")
        songInstance.className = "song-instance"
        // add Song Metadata
        songInstance.append(addSongMetadata(index, song))
        // const index = data.songs.indexOf(song)

        let songBody = addSongStanza(song, index)
        songInstance.append(songBody)
        songFull.append(songInstance)
        dataElem.append(songFull)
      })

      //Add Song Tags

    }


    const addSongTitle = (song) => {
      let elemBlock = document.createElement("div")
      elemBlock.className = "song-title-block"

      const titleElem = renderSongMetadata(null, { id: "title", title: "Title: ", value: song.title, className: "song-title" })
      elemBlock.append(titleElem)

      const genreElem = renderSongMetadata(null, { id: "genre", title: "Genre: ", value: song.genre, className: "song-title" })
      elemBlock.append(genreElem)

      const composerElem = renderSongMetadata(null, { id: "composer", title: "Composer: ", value: song.composer, className: "song-title" })
      elemBlock.append(composerElem)

      const albumElem = renderSongMetadata(null, { id: "album", title: "Album: ", value: song.album, className: "song-title" })
      elemBlock.append(albumElem)

      return elemBlock
    }

    const addSongMetadata = (index, song) => {
      let elemBlock = document.createElement("div")
      elemBlock.className = "song-metadata-block"

      // Song Raagam
      const raagamElem = renderSongMetadata(index, { id: "raagam", title: "Raagam: ", value: song.raagam, className: "song-metadata" })
      elemBlock.append(raagamElem)

      // Song Thaalam
      const thaalamElem = renderSongMetadata(index, { id: "thaalam", title: "Thaalam: ", value: song.thaalam, className: "song-metadata" })
      elemBlock.append(thaalamElem)

      // Song Arohanam
      const arohanamElem = renderSongMetadata(index, { id: "arohanam", title: "Arohanam: ", value: song.arohanam, className: "song-metadata" })
      elemBlock.append(arohanamElem)

      // Song Avarohanam
      const avarohanamElem = renderSongMetadata(index, { id: "avarohanam", title: "Avarohanam: ", value: song.avarohanam, className: "song-metadata" })
      elemBlock.append(avarohanamElem)


      return elemBlock
    }

    const renderSongMetadata = (songIndex, obj) => {
      let metaBlock = document.createElement("div")
      metaBlock.className = obj.className
      let metaLbl = document.createElement("label")
      metaLbl.for = obj.name
      metaLbl.innerHTML = obj.title
      let metaVal = document.createElement("p")
      metaVal.innerText = obj.value

      metaBlock.append(metaLbl, metaVal)
      return metaBlock
    }

    /**
     * Add Song Paragraph
     * @param {Object} song
     * @param {Number} songIndex
     */
    const addSongStanza = (song, songIndex) => {
      let songBody = document.createElement("div")
      songBody.className = "song-body"

      song.stanza.forEach((stz, stzIndex) => {
        let songStanza = document.createElement("div")
        songStanza.className = "song-stanza"

        stz.swaram.forEach((swrVal, swrIndex) => {
          if(swrVal && swrVal.length > 0){
            const swrAttrs = { field: "swaram", className: "swrValues" }
            songStanza.append(renderSwarBlock(songIndex, stzIndex, swrIndex, swrVal, swrAttrs))
          }
          
          if(stz.lyric_en && stz.lyric_en.length > 0){
            const lyrAttrs_en = { field: "lyric_en", className: "lyrValues" }
            songStanza.append(renderSwarBlock(songIndex, stzIndex, swrIndex, stz.lyric_en[swrIndex], lyrAttrs_en))
          }
          
          if(stz.lyric_ta && stz.lyric_ta.length > 0){
            const lyrAttrs_ta = { field: "lyric_ta", className: "lyrValues" }
            songStanza.append(renderSwarBlock(songIndex, stzIndex, swrIndex, stz.lyric_ta[swrIndex], lyrAttrs_ta))
          }

          songBody.append(songStanza)
        })
        // const swrAttrs = { type: "sign", className: "swrValues" }
        // songStanza.append(renderSwarBlock(songIndex, stzIndex, stz.swaram, swrAttrs))

        // const lyrAttrs = { type: "lyric", className: "lyrValues" }
        // songStanza.append(renderSwarBlock(songIndex, stzIndex, stz.lyric, lyrAttrs))
        songBody.append(songStanza)
      })
      return songBody
    }

    /**
     * Add Song Swar Element Block
     * @param {Object} song
     * @param {Number} songIndex
     */
    const renderSwarBlock = (songIndex, stzIndex, swrIndex, val, attrs) => {
      let elemBlock = document.createElement('div')
      elemBlock.className = attrs.className
      elemBlock.append(renderValBlock(songIndex, stzIndex, swrIndex, attrs.field, val))
      return elemBlock
    }

    /**
     * Add Element Block to Swaram & Lyric
     * @param {HTMLElement} elem
     * @param {Array} obj
     * @returns {void}
     **/
    const renderValBlock = (songIndex, stzIndex, swarIndex, field, val) => {
      let elemBlock = document.createElement("p")
      elemBlock.innerText = val
      // if(className) elemBlock.className = className
      return elemBlock
    }

    const downloadSong = () => {
      let data = localStorage.getItem("song");
      const parsedData = JSON.parse(data);
      if (data) {
        const jsonData = JSON.stringify(parsedData);
        const blob = new Blob([jsonData], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${parsedData.id}.json`;
        a.click();
      }
    }

  </script>
</body>

</html>